import {
  app,
  BrowserWindow,
  ipcMain,
  WebContents,
  webContents,
  session,
  globalShortcut,
  shell,
  dialog,
} from "electron";
import { fileURLToPath } from "url";
import path, { dirname, join } from "path";
import { createRequire } from "module";
import fs from "fs";
import { sqlite3, open } from "./database.js";
import CryptoJS from "crypto-js";

// ğŸ”¥ ç®€åŒ–ç‰ˆæœ¬ï¼šçº¯å®¢æˆ·ç«¯å¯¹è¯æ¡†æ‹¦æˆª
console.log('ğŸš€ å¯åŠ¨çº¯å®¢æˆ·ç«¯å¯¹è¯æ¡†æ‹¦æˆªæœºåˆ¶...');

// ä¿å­˜åŸå§‹çš„dialogæ–¹æ³•
const originalShowMessageBox = dialog.showMessageBox;
const originalShowMessageBoxSync = dialog.showMessageBoxSync;
const originalShowErrorBox = dialog.showErrorBox;

// é‡å†™dialog.showMessageBox (å¼‚æ­¥ç‰ˆæœ¬) - æ‹¦æˆªæ‰€æœ‰å¼¹çª—
(dialog as any).showMessageBox = async function(...args: any[]) {
  const [window, options] = args.length === 1 ? [null, args[0]] : args;
  const message = options?.message || options?.detail || '';
  const title = options?.title || '';
  
  console.log('ğŸ” æ‹¦æˆªshowMessageBoxè°ƒç”¨:', { title, message });
  console.log('ğŸš¨ é˜»æ­¢å®¢æˆ·ç«¯å¼¹çª—:', message || title);
  
  // ç›´æ¥è¿”å›é»˜è®¤ç»“æœï¼Œä¸æ˜¾ç¤ºå¼¹çª—
  return { response: 0, checkboxChecked: false }; // è¿”å›"ç¡®å®š"
};

// é‡å†™dialog.showMessageBoxSync (åŒæ­¥ç‰ˆæœ¬) - æ‹¦æˆªæ‰€æœ‰å¼¹çª—
(dialog as any).showMessageBoxSync = function(...args: any[]) {
  const [window, options] = args.length === 1 ? [null, args[0]] : args;
  const message = options?.message || options?.detail || '';
  const title = options?.title || '';
  
  console.log('ğŸ” æ‹¦æˆªshowMessageBoxSyncè°ƒç”¨:', { title, message });
  console.log('ğŸš¨ é˜»æ­¢å®¢æˆ·ç«¯å¼¹çª—:', message || title);
  
  // ç›´æ¥è¿”å›é»˜è®¤ç»“æœï¼Œä¸æ˜¾ç¤ºå¼¹çª—
  return 0; // è¿”å›"ç¡®å®š"
};

// é‡å†™dialog.showErrorBox - æ‹¦æˆªæ‰€æœ‰é”™è¯¯å¼¹çª—
dialog.showErrorBox = function(title: string, content: string) {
  console.log('ğŸ” æ‹¦æˆªshowErrorBoxè°ƒç”¨:', { title, content });
  console.log('ğŸš¨ é˜»æ­¢å®¢æˆ·ç«¯é”™è¯¯å¼¹çª—:', content);
  
  // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æ¡†
  return;
};

// ğŸ”¥ é¢å¤–å¢å¼ºï¼šæ‹¦æˆªshell.openExternal (å¯é€‰ï¼Œé˜²æ­¢å¤–éƒ¨é“¾æ¥æ‰“å¼€)
const originalOpenExternal = shell.openExternal;
shell.openExternal = async (url: string, options?: any) => {
  console.log('ğŸ” æ‹¦æˆªshell.openExternalè°ƒç”¨:', url);
  console.log('ğŸš¨ é˜»æ­¢å¤–éƒ¨é“¾æ¥æ‰“å¼€:', url);
  
  // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œæ‰“å¼€æ“ä½œ
  return;
};

console.log('âœ… çº¯å®¢æˆ·ç«¯å¯¹è¯æ¡†æ‹¦æˆªæœºåˆ¶å·²æ¿€æ´»');

// ğŸš« åœ¨æœ€æ—©æœŸç¦ç”¨æ‰€æœ‰å¯èƒ½å¯¼è‡´åè®®æ³¨å†Œçš„ç‰¹æ€§
app.commandLine.appendSwitch('disable-web-security');
app.commandLine.appendSwitch('disable-features', 'VizDisplayCompositor');
app.commandLine.appendSwitch('allow-running-insecure-content');
app.commandLine.appendSwitch('disable-site-isolation-trials');
app.commandLine.appendSwitch('ignore-certificate-errors');
app.commandLine.appendSwitch('ignore-ssl-errors');
app.commandLine.appendSwitch('ignore-certificate-errors-spki-list');
app.commandLine.appendSwitch('disable-default-apps');  // ç¦ç”¨é»˜è®¤åº”ç”¨æ³¨å†Œ
app.commandLine.appendSwitch('disable-protocol-handler-registration'); // ç¦ç”¨åè®®å¤„ç†å™¨æ³¨å†Œ
app.commandLine.appendSwitch('disable-client-side-phishing-detection');
app.commandLine.appendSwitch('disable-component-update');
console.log('ğŸš« å·²åœ¨åº”ç”¨å¯åŠ¨æ—©æœŸç¦ç”¨æ‰€æœ‰åè®®æ³¨å†Œç‰¹æ€§');

// ä¸º ES Module ç¯å¢ƒåˆ›å»º require å‡½æ•°
const require = createRequire(import.meta.url);

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

let mainWindow: BrowserWindow | null = null;

// RSA åŠ å¯†é…ç½®
const RSA_CONFIG = {
  key: CryptoJS.enc.Utf8.parse('MultiB-Browser-Key32'), // 32å­—ç¬¦å¯†é’¥
  iv: CryptoJS.enc.Utf8.parse('MultiB-Browser-IV16'),   // 16å­—ç¬¦IV
};

// RSA åŠ å¯†å‡½æ•°
function encryptScript(text: string): string {
  try {
    const encrypted = CryptoJS.AES.encrypt(text, RSA_CONFIG.key, {
      iv: RSA_CONFIG.iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    return encrypted.toString();
  } catch (error) {
    console.error('åŠ å¯†å¤±è´¥:', error);
    throw error;
  }
}

// RSA è§£å¯†å‡½æ•°
function decryptScript(encryptedText: string): string {
  try {
    // é¦–å…ˆå°è¯•ä½¿ç”¨base64è§£ç ï¼ˆç”¨äºæ–°çš„é¢„è®¾è„šæœ¬ï¼‰
    try {
      const decoded = Buffer.from(encryptedText, 'base64').toString('utf8');
      // éªŒè¯è§£ç ç»“æœæ˜¯å¦æ˜¯æœ‰æ•ˆçš„JavaScriptä»£ç 
      if (decoded.includes('function') || decoded.includes('console.log') || decoded.includes('document.')) {
        console.log('âœ… ä½¿ç”¨base64è§£å¯†æˆåŠŸ');
        return decoded;
      }
    } catch (base64Error) {
      console.log('Base64è§£ç å¤±è´¥ï¼Œå°è¯•AESè§£å¯†...');
    }
    
    // å¦‚æœbase64è§£ç å¤±è´¥ï¼Œå›é€€åˆ°AESè§£å¯†ï¼ˆç”¨äºæ—§çš„åŠ å¯†è„šæœ¬ï¼‰
    const decrypted = CryptoJS.AES.decrypt(encryptedText, RSA_CONFIG.key, {
      iv: RSA_CONFIG.iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    const result = decrypted.toString(CryptoJS.enc.Utf8);
    console.log('âœ… ä½¿ç”¨AESè§£å¯†æˆåŠŸ');
    return result;
  } catch (error) {
    console.error('è§£å¯†å¤±è´¥:', error);
    throw error;
  }
}

// å…¨å±€é”™è¯¯å¤„ç†
process.on('uncaughtException', (error) => {
  console.error('Uncaught Exception:', error);
  // ä¸è¦é€€å‡ºç¨‹åºï¼Œç»§ç»­è¿è¡Œ
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
  // ä¸è¦é€€å‡ºç¨‹åºï¼Œç»§ç»­è¿è¡Œ
});

// è·å–åº”ç”¨å›¾æ ‡è·¯å¾„
function getIconPath(): string {
  if (process.env.NODE_ENV === "development") {
    // å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨æºç ç›®å½•ä¸­çš„å›¾æ ‡
    // __dirname æŒ‡å‘ dist/electronï¼Œéœ€è¦å›åˆ°é¡¹ç›®æ ¹ç›®å½•
    const projectRoot = path.join(__dirname, "../..");
    const iconPath = path.join(projectRoot, "electron/multi-browser-logo.png");
    console.log(`å¼€å‘ç¯å¢ƒå›¾æ ‡è·¯å¾„: ${iconPath}`);

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    try {
      fs.accessSync(iconPath);
      return iconPath;
    } catch {
      console.warn(`å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: ${iconPath}ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡`);
      return path.join(__dirname, "multi-browser-logo.png");
    }
  } else {
    // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨æ‰“åŒ…åçš„å›¾æ ‡
    if (process.platform === "darwin") {
      // macOS: å°è¯•ä½¿ç”¨ .icns æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ PNG
      const icnsPath = path.join(process.resourcesPath, "multi-browser-logo.icns");
      const pngPath = path.join(__dirname, "multi-browser-logo.png");

      // æ£€æŸ¥ icns æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        fs.accessSync(icnsPath);
        return icnsPath;
      } catch {
        return pngPath;
      }
    } else {
      // Windows/Linux: ä½¿ç”¨ PNG
      return path.join(__dirname, "multi-browser-logo.png");
    }
  }
}

// åˆ é™¤æŒ‡å®špartitionçš„å­˜å‚¨æ–‡ä»¶å¤¹å¹¶æ¸…é™¤sessionæ•°æ®
async function deletePartitionStorageFolder(partitionName: string) {
  try {
    console.log(`ğŸ§¹ å¼€å§‹åˆ é™¤partition "${partitionName}" çš„å­˜å‚¨æ•°æ®...`);

    // ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤sessionä¸­çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬cookiesï¼‰
    try {
      const partitionSession = session.fromPartition(partitionName);
      if (partitionSession) {
        // æ¸…é™¤ç¼“å­˜
        await partitionSession.clearCache();
        console.log(`âœ… å·²æ¸…é™¤partition "${partitionName}" çš„ç¼“å­˜`);

        // æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®ï¼Œç‰¹åˆ«æ˜¯cookies
        await partitionSession.clearStorageData({
          storages: [
            'cookies',           // ğŸª æœ€é‡è¦ï¼šæ¸…é™¤cookies
            'filesystem',
            'indexdb',
            'localstorage',
            'shadercache',
            'websql',
            'serviceworkers',
            'cachestorage',
          ],
        });
        console.log(`âœ… å·²æ¸…é™¤partition "${partitionName}" çš„æ‰€æœ‰å­˜å‚¨æ•°æ®ï¼ˆåŒ…æ‹¬cookiesï¼‰`);
      }
    } catch (sessionError) {
      console.warn(`âš ï¸ æ¸…é™¤partition sessionæ•°æ®æ—¶å‡ºé”™:`, sessionError);
    }

    // ç¬¬äºŒæ­¥ï¼šåˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨æ–‡ä»¶å¤¹
    const userDataPath = app.getPath('userData');
    const partitionPath = path.join(userDataPath, 'Partitions', partitionName.replace('persist:', ''));

    if (fs.existsSync(partitionPath)) {
      await fs.promises.rmdir(partitionPath, { recursive: true });
      console.log(`ğŸ—‘ï¸ å·²åˆ é™¤partitionå­˜å‚¨æ–‡ä»¶å¤¹: ${partitionPath}`);
    } else {
      console.log(`â„¹ï¸ partitionå­˜å‚¨æ–‡ä»¶å¤¹ä¸å­˜åœ¨: ${partitionPath}`);
    }

    console.log(`âœ… partition "${partitionName}" åˆ é™¤å®Œæˆï¼ˆåŒ…æ‹¬cookieså’Œæ‰€æœ‰å­˜å‚¨æ•°æ®ï¼‰`);
    return true;

  } catch (error) {
    console.error(`âŒ åˆ é™¤partitionå­˜å‚¨æ•°æ®å¤±è´¥ "${partitionName}":`, error);
    return false;
  }
}

// æ¸…é™¤æ‰€æœ‰æµè§ˆå™¨å®ä¾‹çš„ç¼“å­˜æ•°æ®å¹¶åˆ é™¤å­˜å‚¨æ–‡ä»¶å¤¹
async function clearAllBrowserInstanceCaches() {
  console.log('ğŸ§¹ å¼€å§‹æ¸…é™¤æ‰€æœ‰æµè§ˆå™¨å®ä¾‹çš„ç¼“å­˜æ•°æ®å’Œå­˜å‚¨æ–‡ä»¶å¤¹...');

  try {
    // è·å–é»˜è®¤session
    const defaultSession = session.defaultSession;
    await defaultSession.clearCache();
    console.log('âœ… é»˜è®¤sessionç¼“å­˜å·²æ¸…é™¤');

    // æ¸…é™¤é»˜è®¤sessionçš„å­˜å‚¨æ•°æ®
    await defaultSession.clearStorageData({
      storages: [
        'cookies',
        'filesystem',
        'indexdb',
        'localstorage',
        'shadercache',
        'websql',
        'serviceworkers',
        'cachestorage',
      ],
    });
    console.log('âœ… é»˜è®¤sessionå­˜å‚¨æ•°æ®å·²æ¸…é™¤');

    // åˆ é™¤æ‰€æœ‰partitionå­˜å‚¨æ–‡ä»¶å¤¹
    try {
      const userDataPath = app.getPath('userData');
      const partitionsPath = path.join(userDataPath, 'Partitions');

      if (fs.existsSync(partitionsPath)) {
        const partitionDirs = await fs.promises.readdir(partitionsPath);
        let deletedFolders = 0;

        for (const partitionDir of partitionDirs) {
          const partitionFolderPath = path.join(partitionsPath, partitionDir);
          const stat = await fs.promises.stat(partitionFolderPath);

          if (stat.isDirectory()) {
            try {
              await fs.promises.rmdir(partitionFolderPath, { recursive: true });
              deletedFolders++;
              console.log(`ğŸ—‘ï¸ å·²åˆ é™¤partitionå­˜å‚¨æ–‡ä»¶å¤¹: ${partitionFolderPath}`);
            } catch (deleteError) {
              console.warn(`âš ï¸ åˆ é™¤partitionæ–‡ä»¶å¤¹å¤±è´¥ "${partitionFolderPath}":`, deleteError);
            }
          }
        }

        console.log(`ğŸ—‘ï¸ æ€»å…±åˆ é™¤äº† ${deletedFolders} ä¸ªpartitionå­˜å‚¨æ–‡ä»¶å¤¹`);
      } else {
        console.log('â„¹ï¸ Partitionsæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤');
      }
    } catch (folderError) {
      console.warn('âš ï¸ åˆ é™¤partitionå­˜å‚¨æ–‡ä»¶å¤¹æ—¶å‡ºé”™:', folderError);
    }

    // å°è¯•ä»æ•°æ®åº“ä¸­è·å–æ‰€æœ‰åŸŸåçš„partitionä¿¡æ¯
    let partitionsFromDB = new Set<string>();
    try {
      const db = await getDb(); // ä½¿ç”¨é»˜è®¤æ•°æ®åº“è·¯å¾„
      const domains = await db.all('SELECT DISTINCT page_id FROM domain');

      domains.forEach((domain: any) => {
        if (domain.page_id) {
          partitionsFromDB.add(`persist:${domain.page_id}`);
        }
      });

      console.log(`ğŸ“Š ä»æ•°æ®åº“ä¸­å‘ç° ${partitionsFromDB.size} ä¸ªpartition`);
    } catch (dbError) {
      console.warn('âš ï¸ æ— æ³•ä»æ•°æ®åº“è·å–partitionä¿¡æ¯ï¼Œä½¿ç”¨é€šç”¨æ¸…é™¤æ–¹æ³•:', dbError);
    }

    // æ·»åŠ ä¸€äº›å¸¸è§çš„partitionæ¨¡å¼ä½œä¸ºå¤‡ç”¨
    const partitionsToTry = new Set<string>();

    // æ·»åŠ æ•°æ®åº“ä¸­çš„partitions
    partitionsFromDB.forEach(partition => partitionsToTry.add(partition));

    // æ·»åŠ åŸºç¡€partitions
    partitionsToTry.add('persist:browser_default');

    // æ·»åŠ ä¸€äº›é€šç”¨æ¨¡å¼ä½œä¸ºå¤‡ç”¨ï¼ˆä»¥é˜²æ•°æ®åº“æ— æ³•è®¿é—®ï¼‰
    for (let i = 1; i <= 50; i++) {
      partitionsToTry.add(`persist:domain_${i}`);
      partitionsToTry.add(`persist:page_${i}`);
    }

    // ä¹Ÿæ¸…é™¤ä¸€äº›å¯èƒ½çš„UUIDæ ¼å¼çš„partition
    // æ³¨æ„ï¼šè¿™ä¸ªå¾ªç¯åªæ˜¯ä¸ºäº†æ¸…é™¤å¯èƒ½é—ç•™çš„partitionï¼Œå®é™…ä½¿ç”¨ä¸­åº”è¯¥ä»¥æ•°æ®åº“ä¸ºå‡†

    let clearedCount = 0;
    let attemptedCount = 0;

    for (const partitionName of partitionsToTry) {
      try {
        attemptedCount++;
        const partitionSession = session.fromPartition(partitionName);

        // æ£€æŸ¥sessionæ˜¯å¦å®é™…å­˜åœ¨ï¼ˆé€šè¿‡å°è¯•è·å–å…¶å±æ€§ï¼‰
        if (partitionSession) {
          await partitionSession.clearCache();
          await partitionSession.clearStorageData({
            storages: [
              'cookies',
              'filesystem',
              'indexdb',
              'localstorage',
              'shadercache',
              'websql',
              'serviceworkers',
              'cachestorage',
            ],
          });
          clearedCount++;
          console.log(`âœ… å·²æ¸…é™¤partition "${partitionName}" çš„ç¼“å­˜å’Œå­˜å‚¨æ•°æ®`);
        }
      } catch (error) {
        // æŸäº›partitionå¯èƒ½ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„
        // åªæœ‰åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºè¿™äº›ä¿¡æ¯
        if (process.env.NODE_ENV === 'development' && attemptedCount <= 10) {
          console.log(`â„¹ï¸ partition "${partitionName}" ä¸å­˜åœ¨æˆ–å·²æ¸…é™¤`);
        }
      }
    }

    console.log(`âœ… æ‰€æœ‰æµè§ˆå™¨å®ä¾‹ç¼“å­˜æ•°æ®æ¸…é™¤å®Œæˆï¼Œå°è¯•äº† ${attemptedCount} ä¸ªpartitionï¼Œå®é™…æ¸…é™¤äº† ${clearedCount} ä¸ª`);

  } catch (error) {
    console.error('âŒ æ¸…é™¤æµè§ˆå™¨å®ä¾‹ç¼“å­˜æ—¶å‘ç”Ÿé”™è¯¯:', error);
  }
}

async function createWindow() {
  const iconPath = getIconPath();
  console.log(`ä½¿ç”¨å›¾æ ‡è·¯å¾„: ${iconPath}`);

  try {
    mainWindow = new BrowserWindow({
      width: 1600,
      height: 800,
      minWidth: 1600,
      minHeight: 800,
      title: "ç›¯æˆ·åŠ©æ‰‹",
      icon: iconPath,
      autoHideMenuBar: true, // éšè—èœå•æ 
      webPreferences: {
        preload: join(__dirname, "preload.js"),
        contextIsolation: true,
        nodeIntegration: false,
        devTools: true,
        webviewTag: true,
        webSecurity: false,
        allowRunningInsecureContent: true,
        // ç¦ç”¨å®éªŒæ€§åŠŸèƒ½ï¼Œé˜²æ­¢è‡ªåŠ¨åè®®æ³¨å†Œ
        experimentalFeatures: false,
        // Windows è¾“å…¥ä¿®å¤ï¼šç¦ç”¨æ‹¼å†™æ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´è¾“å…¥é—®é¢˜
        spellcheck: false,
        // ç¡®ä¿è¾“å…¥äº‹ä»¶æ­£å¸¸ä¼ é€’
        enableBlinkFeatures: 'TouchEventFeatureDetection',
        // ç¦ç”¨è‡ªåŠ¨åè®®å¤„ç†
        navigateOnDragDrop: false,
        // ç¦ç”¨æ’ä»¶
        plugins: false,
        // ç¦ç”¨ webgl
        webgl: false,
      },
    });

    // Windows ç‰¹å®šä¿®å¤ï¼šç¡®ä¿çª—å£å¯ä»¥æ¥æ”¶è¾“å…¥äº‹ä»¶
    if (process.platform === 'win32') {
      mainWindow.setSkipTaskbar(false);
      // ç¡®ä¿çª—å£åœ¨åˆ›å»ºåç«‹å³è·å¾—ç„¦ç‚¹
      mainWindow.once('ready-to-show', () => {
        mainWindow?.show();
        mainWindow?.focus();
      });
    }

    console.log(`å½“å‰ç¯å¢ƒï¼š${process.env.NODE_ENV}`);

    if (process.env.NODE_ENV === "development") {
      // å°è¯•å¤šä¸ªå¯èƒ½çš„ç«¯å£
      const ports = [5173, 5174, 5175, 5176];
      let loaded = false;

      for (const port of ports) {
        try {
          await mainWindow.loadURL(`http://localhost:${port}`);
          console.log(`âœ… æˆåŠŸè¿æ¥åˆ°ç«¯å£ ${port}`);
          loaded = true;
          break;
        } catch (error) {
          console.log(`âŒ ç«¯å£ ${port} è¿æ¥å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
        }
      }

      if (!loaded) {
        throw new Error("æ— æ³•è¿æ¥åˆ°å¼€å‘æœåŠ¡å™¨");
      }

      mainWindow.webContents.openDevTools();
    } else {
      await mainWindow.loadFile(
        join(__dirname, "../../dist/renderer/index.html")
      );
    }

    // ğŸ”¥ å…¨å±€ä¸»è¿›ç¨‹çº§åˆ«çš„å¯¹è¯æ¡†æ‹¦æˆª
    // è¿™æ˜¯æœ€å…³é”®çš„æ‹¦æˆªç‚¹ï¼Œæ‹¦æˆªæ‰€æœ‰webContentså‘èµ·çš„ç³»ç»Ÿå¯¹è¯æ¡†
    app.on('web-contents-created', (event, contents) => {
      console.log('ğŸ” æ–°çš„web-contentsåˆ›å»º:', contents.id);
      
      // ç§»é™¤åè®®æ‹¦æˆªï¼Œä¿æŒæ­£å¸¸åŠŸèƒ½
    });

    // ğŸ”¥ ä¸»çª—å£çº§åˆ«çš„å¯¹è¯æ¡†æ‹¦æˆª
    mainWindow.webContents.on('dom-ready', () => {
      console.log('ğŸ”¥ ä¸»çª—å£DOMå°±ç»ªï¼Œæ³¨å…¥å…¨å±€å¯¹è¯æ¡†æ‹¦æˆª...');
      
      // åœ¨ä¸»çª—å£æ³¨å…¥æœ€é«˜ä¼˜å…ˆçº§çš„æ‹¦æˆªä»£ç 
      mainWindow?.webContents.executeJavaScript(`
        (function() {
          console.log('ğŸ›¡ï¸ ä¸»çª—å£çº§åˆ«å¯¹è¯æ¡†æ‹¦æˆªæ¿€æ´»...');
          
          // æœ€é«˜ä¼˜å…ˆçº§æ‹¦æˆª
          const originalConfirm = window.confirm;
          const originalAlert = window.alert;
          
          window.confirm = function(message) {
            console.log('ğŸ” ä¸»çª—å£æ‹¦æˆªconfirmè°ƒç”¨:', message);
            if (typeof message === 'string') {
              const protocolMessages = [
                'æœªè®¾å®šç”¨æ¥æ‰“å¼€URL',
                'æ²¡æœ‰è®¾ç½®ç”¨æ¥æ‰“å¼€URL',
                'æ— æ³•æ‰“å¼€',
                'protocol',
                'bytedance',
                'douyin',
                'toutiao',
                'dispatch_message',
                'è®¾ç½®é»˜è®¤åº”ç”¨',
                'Open with',
                'No application',
                'unhandled protocol'
              ];
              
              if (protocolMessages.some(keyword => message.toLowerCase().includes(keyword.toLowerCase()))) {
                console.warn('ğŸš¨ ä¸»çª—å£çº§åˆ«é˜»æ­¢åè®®ç¡®è®¤æ¡†:', message);
                return true; // å‡è£…ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®š
              }
            }
            return originalConfirm.call(this, message);
          };
          
          window.alert = function(message) {
            console.log('ğŸ” ä¸»çª—å£æ‹¦æˆªalertè°ƒç”¨:', message);
            if (typeof message === 'string') {
              const protocolMessages = [
                'æœªè®¾å®šç”¨æ¥æ‰“å¼€URL',
                'æ²¡æœ‰è®¾ç½®ç”¨æ¥æ‰“å¼€URL',
                'æ— æ³•æ‰“å¼€',
                'protocol',
                'bytedance',
                'douyin',
                'toutiao',
                'dispatch_message',
                'è®¾ç½®é»˜è®¤åº”ç”¨',
                'Open with',
                'No application',
                'unhandled protocol'
              ];
              
              if (protocolMessages.some(keyword => message.toLowerCase().includes(keyword.toLowerCase()))) {
                console.warn('ğŸš¨ ä¸»çª—å£çº§åˆ«é˜»æ­¢åè®®è­¦å‘Šæ¡†:', message);
                return; // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºè­¦å‘Šæ¡†
              }
            }
            return originalAlert.call(this, message);
          };
          
          console.log('âœ… ä¸»çª—å£çº§åˆ«å¯¹è¯æ¡†æ‹¦æˆªå·²æ¿€æ´»');
        })();
      `).catch(err => {
        console.error('æ³¨å…¥ä¸»çª—å£å¯¹è¯æ¡†æ‹¦æˆªå¤±è´¥:', err);
      });
    });

    // Windows è¾“å…¥ä¿®å¤ï¼šæ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    if (process.platform === 'win32') {
      mainWindow.webContents.on('dom-ready', () => {
        // æ³¨å…¥ä¿®å¤è¾“å…¥é—®é¢˜çš„ä»£ç 
        mainWindow?.webContents.executeJavaScript(`
          // ä¿®å¤ Windows ä¸‹è¾“å…¥æ¡†æ— æ³•è¾“å…¥çš„é—®é¢˜
          document.addEventListener('DOMContentLoaded', function() {
            // å¼ºåˆ¶å¯ç”¨æ‰€æœ‰è¾“å…¥å…ƒç´ 
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
              input.removeAttribute('readonly');
              input.removeAttribute('disabled');
            });
            
            // ä¿®å¤ç„¦ç‚¹é—®é¢˜
            document.addEventListener('click', function(e) {
              if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                e.target.focus();
              }
            });
            
            console.log('Windows è¾“å…¥ä¿®å¤å·²åº”ç”¨');
          });
          
          // ç«‹å³åº”ç”¨ä¿®å¤
          const inputs = document.querySelectorAll('input, textarea');
          inputs.forEach(input => {
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
          });
        `);
      });
    }

    mainWindow.webContents.on(
      "did-attach-webview",
      (_event, contents: WebContents) => {
        // è®¾ç½®webviewçš„çª—å£æ‰“å¼€å¤„ç†å™¨ - å¢å¼ºå®‰å…¨ç‰ˆæœ¬
        contents.setWindowOpenHandler(({ url, frameName, features, disposition }) => {
          console.log('å¤–é“¾è¯·æ±‚:', url);
          console.log('çª—å£ç‰¹æ€§:', { frameName, features, disposition });

          // æ£€æŸ¥å±é™©åè®®
          const appProtocols = ['bytedance:', 'toutiao:', 'douyin:', 'xigua:', 'aweme:', 'snssdk:', 'javascript:', 'data:', 'vbscript:'];
          if (appProtocols.some(protocol => url.toLowerCase().startsWith(protocol))) {
            console.warn('ğŸš¨ é˜»æ­¢åº”ç”¨åè®®:', url);
            return { action: 'deny' };
          }

          // æ£€æŸ¥å¯èƒ½è§¦å‘åº”ç”¨å¯åŠ¨çš„ç‰¹æ®ŠURLæ¨¡å¼
          const dangerousPatterns = [
            /zijieapi\.com.*api\/link/i,  // å­—èŠ‚è·³åŠ¨APIé“¾æ¥
            /security\.zijieapi\.com/i,   // å®‰å…¨API
            /isBlank=true/i,              // å¯èƒ½æ‰“å¼€æ–°çª—å£çš„å‚æ•°
            /targetUrl.*bytedance/i,      // ç›®æ ‡URLåŒ…å«å­—èŠ‚è·³åŠ¨
            /targetUrl.*douyin/i,         // ç›®æ ‡URLåŒ…å«æŠ–éŸ³
            /openapp\./i,                 // appæ‰“å¼€ç›¸å…³
            /intent:/i,                   // Android intentåè®®
            /market:/i,                   // åº”ç”¨å•†åº—åè®®
          ];

          const hasDangerousPattern = dangerousPatterns.some(pattern => pattern.test(url));
          if (hasDangerousPattern) {
            console.warn('ğŸš¨ å®Œå…¨é˜»æ­¢å±é™©æ–°çª—å£/APIè°ƒç”¨:', url);
            return { action: 'deny' };
          }

          // é€šçŸ¥æ¸²æŸ“è¿›ç¨‹åˆ›å»ºæ–°æ ‡ç­¾é¡µ
          mainWindow?.webContents.send("webview-open-url", {
            url,
            webContentsId: contents.id
          });

          return { action: 'deny' };
        });

        // æ·»åŠ é”™è¯¯å¤„ç†
        contents.on('crashed' as any, (event: any) => {
          console.warn('webview crashed:', event);
        });

        contents.on('unresponsive' as any, () => {
          console.warn('webview became unresponsive');
        });

        contents.on('responsive' as any, () => {
          console.log('webview became responsive again');
        });

        // // å…è®¸webviewåŠ è½½æ›´å¤šç±»å‹çš„å†…å®¹
        // contents.session.webRequest.onBeforeSendHeaders((details, callback) => {
        //   // è®¾ç½®çœŸå®çš„Chrome User-Agent
        //   details.requestHeaders['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';

        //   // å¯¹äºå·¨é‡å¼•æ“ï¼Œæ·»åŠ ç‰¹æ®Šé…ç½®
        //   if (details.url.includes('oceanengine.com') || details.url.includes('business.oceanengine.com')) {
        //     details.requestHeaders['Referer'] = 'https://business.oceanengine.com/';
        //     details.requestHeaders['Accept'] = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7';
        //     details.requestHeaders['Accept-Language'] = 'zh-CN,zh;q=0.9,en;q=0.8';
        //     details.requestHeaders['Cache-Control'] = 'no-cache';
        //     details.requestHeaders['Pragma'] = 'no-cache';
        //     details.requestHeaders['Sec-Fetch-Dest'] = 'document';
        //     details.requestHeaders['Sec-Fetch-Mode'] = 'navigate';
        //     details.requestHeaders['Sec-Fetch-Site'] = 'same-origin';
        //     details.requestHeaders['Sec-Ch-Ua'] = '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        //     details.requestHeaders['Sec-Ch-Ua-Mobile'] = '?0';
        //     details.requestHeaders['Sec-Ch-Ua-Platform'] = '"Windows"';
        //     details.requestHeaders['Upgrade-Insecure-Requests'] = '1';
        //   } else if (details.url.includes('baidu.com') || details.url.includes('www.baidu.com')) {
        //     // å¯¹äºç™¾åº¦æœç´¢ï¼Œæ·»åŠ æ›´å¤šå¿…è¦çš„å¤´éƒ¨
        //     details.requestHeaders['Referer'] = 'https://www.baidu.com/';
        //     details.requestHeaders['Accept'] = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7';
        //     details.requestHeaders['Accept-Language'] = 'zh-CN,zh;q=0.9,en;q=0.8';
        //     details.requestHeaders['Cache-Control'] = 'no-cache';
        //     details.requestHeaders['Pragma'] = 'no-cache';
        //   } else {
        //     // å¯¹äºå…¶ä»–ç½‘ç«™ï¼Œæ·»åŠ é€šç”¨referer
        //     details.requestHeaders['Referer'] = 'https://www.google.com/';
        //   }

        //   console.log('è¯·æ±‚å¤´è®¾ç½®:', details.url, details.requestHeaders['User-Agent']);
        //   callback({ requestHeaders: details.requestHeaders });
        // });

        // å…è®¸æ‰€æœ‰æƒé™è¯·æ±‚ï¼ˆæ‘„åƒå¤´ã€éº¦å…‹é£ã€é€šçŸ¥ç­‰ï¼‰
        contents.session.setPermissionRequestHandler((webContents, permission, callback) => {
          // å¯¹äºå¤§éƒ¨åˆ†æƒé™ï¼Œæˆ‘ä»¬éƒ½å…è®¸
          callback(true);
        });

        // ğŸš« è®¾ç½®åè®®å¤„ç†å™¨æ‹¦æˆª - é˜»æ­¢å¤–éƒ¨åº”ç”¨æ‰“å¼€è¯·æ±‚
        contents.session.setPermissionCheckHandler((webContents, permission, requestingOrigin, details) => {
          // å¦‚æœæ˜¯å¤–éƒ¨åº”ç”¨æ‰“å¼€ç›¸å…³çš„æƒé™ï¼Œç›´æ¥æ‹’ç»
          if (permission === 'openExternal') {
            console.warn('ğŸš¨ é˜»æ­¢å¤–éƒ¨åº”ç”¨æ‰“å¼€æƒé™è¯·æ±‚:', permission, requestingOrigin, details);
            return false;
          }
          return true;
        });

        // è®¾ç½®æ›´å®½æ¾çš„å†…å®¹å®‰å…¨ç­–ç•¥ (ä¿ç•™æ­£å¸¸åŠŸèƒ½)
        contents.session.webRequest.onHeadersReceived((details, callback) => {
          const responseHeaders = details.responseHeaders || {};

          // ç§»é™¤ä¸¥æ ¼çš„å®‰å…¨å¤´
          delete responseHeaders['content-security-policy'];
          delete responseHeaders['content-security-policy-report-only'];
          delete responseHeaders['x-frame-options'];
          delete responseHeaders['x-content-type-options'];
          delete responseHeaders['strict-transport-security'];
          delete responseHeaders['x-xss-protection'];

          // æ·»åŠ å…è®¸è·¨åŸŸçš„å¤´
          responseHeaders['access-control-allow-origin'] = ['*'];
          responseHeaders['access-control-allow-methods'] = ['GET, POST, PUT, DELETE, OPTIONS'];
          responseHeaders['access-control-allow-headers'] = ['*'];

          callback({ responseHeaders });
        });

        // è¯ä¹¦é”™è¯¯å¤„ç†
        contents.on('certificate-error', (event, url, error, certificate, callback) => {
          event.preventDefault();
          callback(true);
        });

        // ğŸ”¥ å…³é”®ï¼šæ‹¦æˆªç½‘é¡µå‘èµ·çš„åè®®ç›¸å…³å¯¹è¯æ¡†
        // ç§»é™¤new-windowæ‹¦æˆªï¼Œä¿æŒæ­£å¸¸åŠŸèƒ½
        contents.on('new-window' as any, (event: any, url: string) => {
          console.log('ğŸ” new-windowäº‹ä»¶:', url);
          // å…è®¸æ‰€æœ‰new-windowè¯·æ±‚æ­£å¸¸å¤„ç†
        });
        
        // ç®€åŒ–çš„DOMå¤„ç†
        contents.on('dom-ready', () => {
          // åªæ³¨å…¥çº¯å¯¹è¯æ¡†æ‹¦æˆªï¼Œä¸æ£€æµ‹åè®®
          contents.executeJavaScript(`
            (function() {
              console.log('ğŸ”¥ å¯åŠ¨çº¯å®¢æˆ·ç«¯å¯¹è¯æ¡†æ‹¦æˆª...');
              
              // ä¿å­˜åŸå§‹æ–¹æ³•
              const originalConfirm = window.confirm;
              const originalAlert = window.alert;
              
              // æ‹¦æˆªæ‰€æœ‰confirmè°ƒç”¨
              window.confirm = function(message) {
                console.log('ğŸš¨ æ‹¦æˆªconfirmè°ƒç”¨:', message);
                return true; // ç›´æ¥è¿”å›trueï¼Œä¸æ˜¾ç¤ºå¼¹çª—
              };
              
              // æ‹¦æˆªæ‰€æœ‰alertè°ƒç”¨
              window.alert = function(message) {
                console.log('ğŸš¨ æ‹¦æˆªalertè°ƒç”¨:', message);
                return; // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
              };
              
              console.log('âœ… çº¯å®¢æˆ·ç«¯å¯¹è¯æ¡†æ‹¦æˆªå·²æ¿€æ´»');
            })();
          `).catch(err => {
            console.error('æ³¨å…¥å¯¹è¯æ¡†æ‹¦æˆªå¤±è´¥:', err);
          });
        });
                    'æ²¡æœ‰è®¾ç½®ç”¨æ¥æ‰“å¼€URL',
                    'æ— æ³•æ‰“å¼€',
                    'protocol',
                    'bytedance',
                    'douyin',
                    'toutiao',
                    'dispatch_message'
                  ];
                  
                  if (protocolMessages.some(keyword => message.toLowerCase().includes(keyword.toLowerCase()))) {
                    console.warn('ğŸš¨ é˜»æ­¢åè®®ç›¸å…³ç¡®è®¤æ¡†:', message);
                    return true; // å‡è£…ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®š
                  }
                }
                return originalConfirm.call(this, message);
              };
              
              window.alert = function(message) {
                if (typeof message === 'string') {
                  // æ£€æŸ¥æ˜¯å¦æ˜¯åè®®ç›¸å…³çš„è­¦å‘Šæ¡†
                  const protocolMessages = [
                    'æœªè®¾å®šç”¨æ¥æ‰“å¼€URL',
                    'æ²¡æœ‰è®¾ç½®ç”¨æ¥æ‰“å¼€URL',
                    'æ— æ³•æ‰“å¼€',
                    'protocol',
                    'bytedance',
                    'douyin',
                    'toutiao',
                    'dispatch_message'
                  ];
                  
                  if (protocolMessages.some(keyword => message.toLowerCase().includes(keyword.toLowerCase()))) {
                    console.warn('ğŸš¨ é˜»æ­¢åè®®ç›¸å…³è­¦å‘Šæ¡†:', message);
                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºè­¦å‘Šæ¡†
                  }
                }
                return originalAlert.call(this, message);
              };

              // ğŸ­ ä¼ªè£…åè®®æ”¯æŒ - è®©ç½‘ç«™è®¤ä¸ºåè®®å·²ç»æ”¯æŒ
              if (typeof navigator !== 'undefined') {
                // é‡å†™ registerProtocolHandlerï¼Œå‡è£…æˆåŠŸæ³¨å†Œ
                navigator.registerProtocolHandler = function(protocol, url, title) {
                  console.log('ğŸ­ ä¼ªè£…åè®®æ³¨å†ŒæˆåŠŸ:', protocol, url, title);
                  return undefined; // å‡è£…æˆåŠŸ
                };

                // æ·»åŠ  isProtocolHandlerRegisteredï¼Œæ€»æ˜¯è¿”å›å·²æ³¨å†Œ
                if (!navigator.isProtocolHandlerRegistered) {
                  navigator.isProtocolHandlerRegistered = function(scheme, url) {
                    const isProblematic = problematicProtocols.some(p => scheme.includes(p.replace(':', '')));
                    if (isProblematic) {
                      console.log('ğŸ­ ä¼ªè£…åè®®å·²æ³¨å†Œ:', scheme, url);
                      return 'registered'; // å‡è£…å·²æ³¨å†Œ
                    }
                    return 'declined';
                  };
                }

                // æ·»åŠ  msLaunchUri æ–¹æ³•ï¼ˆIE/Edgeåè®®å¯åŠ¨ï¼‰
                if (!navigator.msLaunchUri) {
                  navigator.msLaunchUri = function(uri, successCallback, noHandlerCallback) {
                    console.log('ğŸ­ ä¼ªè£…msLaunchUriæˆåŠŸ:', uri);
                    const isDangerous = problematicProtocols.some(p => uri.startsWith(p));
                    if (isDangerous && successCallback) {
                      setTimeout(successCallback, 10); // å‡è£…æˆåŠŸ
                    } else if (noHandlerCallback) {
                      setTimeout(noHandlerCallback, 10);
                    }
                  };
                }
              }

              console.log('âœ… è¶…å¼ºåè®®æ£€æµ‹é˜»æ­¢è„šæœ¬åŠ è½½å®Œæˆ');
            })();
          `).catch(err => {
            console.error('æ³¨å…¥è¶…å¼ºåè®®æ‹¦æˆªè„šæœ¬å¤±è´¥:', err);
          });

          // ç„¶åæ³¨å…¥åŸæœ‰çš„æ‹¦æˆªè„šæœ¬
          contents.executeJavaScript(`
            // é˜»æ­¢ç½‘é¡µæ³¨å†Œåè®®å¤„ç†å™¨
            if (typeof navigator !== 'undefined' && navigator.registerProtocolHandler) {
              const originalRegisterProtocolHandler = navigator.registerProtocolHandler;
              navigator.registerProtocolHandler = function(protocol, url, title) {
                console.warn('ğŸš¨ é˜»æ­¢ç½‘é¡µæ³¨å†Œåè®®å¤„ç†å™¨:', protocol, url, title);
                // ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›
                return;
              };
              console.log('âœ… å·²ç¦ç”¨ navigator.registerProtocolHandler');
            }
            
            // å¢å¼ºçš„åè®®é“¾æ¥æ‹¦æˆªå™¨
            if (typeof window !== 'undefined') {
              // å®šä¹‰é—®é¢˜åè®®åˆ—è¡¨
              const problematicProtocols = [
                'bytedance:', 'douyin:', 'toutiao:', 'xigua:', 'aweme:', 'snssdk:',
                'bytedance-frontend:', 'bytedance-service:', 'bytedance-ads:',
                'douyin-fe:', 'douyin-service:', 'douyin-creator:',
                'intent:', 'market:', 'itms:', 'itms-apps:'
              ];
              
              // å®šä¹‰å±é™©URLæ¨¡å¼
              const dangerousPatterns = [
                /dispatch_message/i,
                /openapp\\./i,
                /app\\.link/i,
                /deeplink/i,
                /universal\\.link/i,
                /zijieapi\\.com.*link/i,
                /security\\.zijieapi\\.com/i,
                /targetUrl.*protocol/i,
                /scheme.*bytedance/i,
                /scheme.*douyin/i
              ];
              
              // æ£€æŸ¥URLæ˜¯å¦å±é™©
              function isDangerousUrl(url) {
                if (!url) return false;
                const lowerUrl = url.toLowerCase();
                
                // æ£€æŸ¥åè®®
                if (problematicProtocols.some(protocol => lowerUrl.startsWith(protocol))) {
                  return true;
                }
                
                // æ£€æŸ¥æ¨¡å¼
                if (dangerousPatterns.some(pattern => pattern.test(url))) {
                  return true;
                }
                
                return false;
              }
              
              // é‡å†™window.openæ–¹æ³•
              const originalWindowOpen = window.open;
              window.open = function(url, target, features) {
                if (isDangerousUrl(url)) {
                  console.warn('ğŸš¨ é˜»æ­¢window.openæ‰“å¼€å±é™©URL:', url);
                  return null;
                }
                return originalWindowOpen.call(this, url, target, features);
              };
              
              // é‡å†™location.hrefè®¾ç½®
              const originalLocationHref = Object.getOwnPropertyDescriptor(Location.prototype, 'href');
              if (originalLocationHref && originalLocationHref.set) {
                Object.defineProperty(Location.prototype, 'href', {
                  set: function(url) {
                    if (isDangerousUrl(url)) {
                      console.warn('ï¿½ é˜»æ­¢location.hrefè·³è½¬åˆ°å±é™©URL:', url);
                      return;
                    }
                    originalLocationHref.set.call(this, url);
                  },
                  get: originalLocationHref.get,
                  enumerable: true,
                  configurable: true
                });
              }
              
              // æ‹¦æˆªæ‰€æœ‰åè®®é“¾æ¥çš„ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿ä¼˜å…ˆå¤„ç†ï¼‰
              document.addEventListener('click', function(e) {
                // æ£€æŸ¥ç‚¹å‡»ç›®æ ‡åŠå…¶çˆ¶å…ƒç´ çš„é“¾æ¥
                let target = e.target;
                let href = null;
                
                // å‘ä¸ŠæŸ¥æ‰¾æœ€å¤š5å±‚ï¼Œå¯»æ‰¾æœ‰hrefå±æ€§çš„å…ƒç´ 
                for (let i = 0; i < 5 && target; i++) {
                  if (target.href) {
                    href = target.href;
                    break;
                  }
                  if (target.getAttribute && target.getAttribute('href')) {
                    href = target.getAttribute('href');
                    break;
                  }
                  target = target.parentElement;
                }
                
                if (href && isDangerousUrl(href)) {
                  console.warn('ğŸš¨ é˜»æ­¢ç‚¹å‡»å±é™©åè®®é“¾æ¥:', href);
                  e.preventDefault();
                  e.stopPropagation();
                  e.stopImmediatePropagation();
                  return false;
                }
              }, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
              
              // é˜»æ­¢é¡µé¢å¸è½½æ—¶çš„åè®®å¤„ç†
              window.addEventListener('beforeunload', function(e) {
                console.log('ğŸš« é¡µé¢å¸è½½æ—¶é˜»æ­¢åè®®å¤„ç†');
              });
              
              // ç›‘å¬hashchangeäº‹ä»¶ï¼Œé˜²æ­¢é€šè¿‡hashæ”¹å˜è§¦å‘åè®®
              window.addEventListener('hashchange', function(e) {
                if (isDangerousUrl(window.location.hash)) {
                  console.warn('ğŸš¨ é˜»æ­¢å±é™©hashå˜åŒ–:', window.location.hash);
                  e.preventDefault();
                  return false;
                }
              });
              
              // é˜»æ­¢é€šè¿‡iframeçš„srcå±æ€§è®¾ç½®å±é™©URL
              const originalCreateElement = document.createElement;
              document.createElement = function(tagName) {
                const element = originalCreateElement.call(this, tagName);
                
                if (tagName.toLowerCase() === 'iframe') {
                  const originalSetAttribute = element.setAttribute;
                  element.setAttribute = function(name, value) {
                    if (name.toLowerCase() === 'src' && isDangerousUrl(value)) {
                      console.warn('ğŸš¨ é˜»æ­¢iframeè®¾ç½®å±é™©src:', value);
                      return;
                    }
                    return originalSetAttribute.call(this, name, value);
                  };
                }
                
                return element;
              };
              
              console.log('âœ… å·²æ³¨å…¥å¢å¼ºåè®®æ‹¦æˆªè„šæœ¬');
            }
          `).catch(err => {
            console.error('æ³¨å…¥åè®®æ‹¦æˆªè„šæœ¬å¤±è´¥:', err);
          });
        });

        // å¤„ç†å¯¼èˆªäº‹ä»¶ - ä»…è®°å½•ï¼Œä¸æ‹¦æˆª
        contents.on('will-navigate', (event, url) => {
          console.log('webviewå³å°†å¯¼èˆªåˆ°:', url);
          // å…è®¸æ‰€æœ‰å¯¼èˆªæ­£å¸¸è¿›è¡Œ
        });

        // ç›‘å¬æ‰€æœ‰å¯¼èˆªé‡å®šå‘ - ä»…è®°å½•ï¼Œä¸æ‹¦æˆª
        contents.on('will-redirect', (event, url) => {
          console.log('webviewå³å°†é‡å®šå‘åˆ°:', url);
          // å…è®¸æ‰€æœ‰é‡å®šå‘æ­£å¸¸è¿›è¡Œ
        });

        // ç›‘å¬å¤–éƒ¨åè®®è¯·æ±‚
        contents.on('will-prevent-unload', (event) => {
          console.log('webviewå°è¯•é˜»æ­¢å¸è½½');
        });

        // å¤„ç†åŠ è½½å¤±è´¥
        contents.on('did-fail-load', (event, errorCode, errorDescription, validatedURL) => {
          if (errorCode !== -3) { // -3æ˜¯ERR_ABORTEDï¼Œé€šå¸¸æ˜¯æ­£å¸¸çš„
            console.error(`webviewåŠ è½½å¤±è´¥: ${errorCode} - ${errorDescription} - ${validatedURL}`);
          }
        });
      }
    );

    // ç”Ÿäº§ç¯å¢ƒä¹Ÿæ‰“å¼€DevToolsä»¥ä¾¿è°ƒè¯•
    // mainWindow.webContents.openDevTools();
    // console.log("âœ… ç”Ÿäº§ç¯å¢ƒDevToolså·²æ‰“å¼€");
  } catch (err) {
    console.error("åˆ›å»ºçª—å£å¤±è´¥ï¼š", err);
  }
}

// ğŸš« ç§»é™¤å•å®ä¾‹é”ï¼Œå› ä¸ºå®ƒå¯èƒ½å¯¼è‡´åè®®è‡ªåŠ¨æ³¨å†Œ
// å•å®ä¾‹é”å·²è¢«ç§»é™¤ä»¥é˜²æ­¢åè®®å¤„ç†å™¨è‡ªåŠ¨æ³¨å†Œ
console.log('ï¿½ å·²ç¦ç”¨å•å®ä¾‹é”ä»¥é˜²æ­¢åè®®æ³¨å†Œ');

// æ•è·é¡¶å±‚ promise æ‹’ç»
app
  .whenReady()
  .then(async () => {
    // ğŸš« åœ¨åº”ç”¨å¯åŠ¨æ—¶é‡å†™å…¨å±€shell.openExternalæ–¹æ³•
    const originalShellOpenExternal = shell.openExternal;
    shell.openExternal = function(url: string, options?: any) {
      const problematicProtocols = ['bytedance:', 'douyin:', 'toutiao:', 'xigua:', 'aweme:', 'snssdk:'];
      const lowerUrl = url.toLowerCase();
      
      if (problematicProtocols.some(protocol => lowerUrl.startsWith(protocol))) {
        console.warn('ğŸš¨ å…¨å±€é˜»æ­¢shell.openExternalæ‰“å¼€é—®é¢˜åè®®:', url);
        return Promise.resolve();
      }
      
      // æ£€æŸ¥å±é™©URLæ¨¡å¼
      const dangerousPatterns = [
        /dispatch_message/i,
        /openapp\./i,
        /app\.link/i,
        /deeplink/i,
        /universal\.link/i,
        /zijieapi\.com.*link/i,
        /security\.zijieapi\.com/i,
      ];
      
      if (dangerousPatterns.some(pattern => pattern.test(url))) {
        console.warn('ğŸš¨ å…¨å±€é˜»æ­¢shell.openExternalæ‰“å¼€å±é™©URLæ¨¡å¼:', url);
        return Promise.resolve();
      }
      
      return originalShellOpenExternal.call(this, url, options);
    };
    console.log('âœ… å·²å…¨å±€é‡å†™shell.openExternalæ–¹æ³•');

    // ğŸ§¹ å¼ºåˆ¶æ¸…é™¤å¯èƒ½å·²æ³¨å†Œçš„é—®é¢˜åè®®å¤„ç†å™¨ - æ›´å…¨é¢çš„æ¸…ç†
    const allPossibleProtocols = [
      'bytedance', 'toutiao', 'douyin', 'xigua', 'aweme', 'snssdk',
      'bytedance-frontend', 'bytedance-service', 'bytedance-ads',
      'douyin-fe', 'douyin-service', 'douyin-creator',
      'multi-browser', 'multi-brower', // é˜²æ­¢è‡ªå·±çš„åº”ç”¨åè¢«æ³¨å†Œ
    ];
    console.log('ğŸ” å¼€å§‹å¼ºåˆ¶æ¸…ç†æ‰€æœ‰å·²æ³¨å†Œçš„åè®®å¤„ç†å™¨...');
    
    for (const protocol of allPossibleProtocols) {
      try {
        // æ— è®ºæ˜¯å¦å·²æ³¨å†Œï¼Œéƒ½å°è¯•ç§»é™¤
        app.removeAsDefaultProtocolClient(protocol);
        console.log(`âœ… å·²å¼ºåˆ¶æ¸…ç†åè®®å¤„ç†å™¨: ${protocol}://`);
      } catch (error) {
        // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ¸…ç†
        console.log(`â„¹ï¸ åè®®æ¸…ç†: ${protocol}:// (${(error as Error)?.message || 'æœªæ³¨å†Œ'})`);
      }
    }

    // ğŸš« å®Œå…¨ç¦ç”¨åè®®å¤„ç†å™¨æ³¨å†ŒAPI - æœ€å¼ºé˜»æ­¢æªæ–½
    const originalSetAsDefaultProtocolClient = app.setAsDefaultProtocolClient;
    const originalIsDefaultProtocolClient = app.isDefaultProtocolClient;
    const originalRemoveAsDefaultProtocolClient = app.removeAsDefaultProtocolClient;
    
    app.setAsDefaultProtocolClient = function(protocol: string, ...args: any[]) {
      console.warn(`ğŸš¨ å®Œå…¨é˜»æ­¢æ³¨å†Œåè®®å¤„ç†å™¨: ${protocol}://`);
      console.warn(`ğŸš¨ è°ƒç”¨æ ˆ:`, new Error().stack);
      return false; // æ€»æ˜¯è¿”å›å¤±è´¥
    };
    
    app.isDefaultProtocolClient = function(protocol: string, ...args: any[]) {
      console.log(`â„¹ï¸ æŸ¥è¯¢åè®®çŠ¶æ€: ${protocol}:// - è¿”å›false(æœªæ³¨å†Œ)`);
      return false; // æ€»æ˜¯è¿”å›æœªæ³¨å†ŒçŠ¶æ€
    };
    
    app.removeAsDefaultProtocolClient = function(protocol: string, ...args: any[]) {
      console.log(`âœ… å°è¯•ç§»é™¤åè®®å¤„ç†å™¨: ${protocol}:// - å·²é˜»æ­¢`);
      return true; // å‡è£…ç§»é™¤æˆåŠŸ
    };

    // æ·»åŠ å…¨å±€åè®®è¯·æ±‚ç›‘å¬ï¼Œç”¨äºè°ƒè¯•
    app.on('open-url', (event, url) => {
      event.preventDefault();
      console.warn('ğŸš¨ æ”¶åˆ°å¤–éƒ¨åè®®è¯·æ±‚:', url);
      console.warn('ğŸš¨ è¿™å¯èƒ½æ˜¯å¯¼è‡´åº”ç”¨é‡å¤å¯åŠ¨çš„åŸå› ');
      // å®Œå…¨é˜»æ­¢å¤„ç†ï¼Œä¸åšä»»ä½•æ“ä½œ
    });

    // ğŸš« ç§»é™¤äº†second-instanceç›‘å¬å™¨ï¼Œå› ä¸ºå•å®ä¾‹é”å·²è¢«ç¦ç”¨

    // ğŸ§¹ å¯åŠ¨æ—¶æ¸…é™¤æ‰€æœ‰æµè§ˆå™¨å®ä¾‹çš„ç¼“å­˜æ•°æ® - å·²ç¦ç”¨
    // await clearAllBrowserInstanceCaches();

    // æ³¨å†Œå…¨å±€å¿«æ·é”®æ¥å¼€å…³DevTools
    globalShortcut.register('F12', () => {
      if (mainWindow && mainWindow.webContents) {
        if (mainWindow.webContents.isDevToolsOpened()) {
          mainWindow.webContents.closeDevTools();
          console.log('âœ… DevToolså·²å…³é—­');
        } else {
          mainWindow.webContents.openDevTools();
          console.log('âœ… DevToolså·²æ‰“å¼€');
        }
      }
    });

    // æ³¨å†Œå¦ä¸€ä¸ªå¿«æ·é”® Ctrl+Shift+I
    globalShortcut.register('CommandOrControl+Shift+I', () => {
      if (mainWindow && mainWindow.webContents) {
        if (mainWindow.webContents.isDevToolsOpened()) {
          mainWindow.webContents.closeDevTools();
          console.log('âœ… DevToolså·²å…³é—­ (Ctrl+Shift+I)');
        } else {
          mainWindow.webContents.openDevTools();
          console.log('âœ… DevToolså·²æ‰“å¼€ (Ctrl+Shift+I)');
        }
      }
    });

    console.log('âœ… å·²æ³¨å†ŒDevToolså¿«æ·é”®: F12 å’Œ Ctrl+Shift+I');

    // ğŸš« å‘½ä»¤è¡Œå¼€å…³å·²åœ¨æ–‡ä»¶é¡¶éƒ¨è®¾ç½®ï¼Œè¿™é‡Œä¸å†é‡å¤

    // ğŸš« å®Œå…¨ç¦ç”¨åè®®æ³¨å†Œ - ä¸å†æ³¨å†Œä»»ä½•åè®®å¤„ç†å™¨
    // è¿™å¯ä»¥é˜²æ­¢ç½‘é¡µè‡ªåŠ¨æ³¨å†Œæˆ‘ä»¬çš„åº”ç”¨ä¸ºåè®®å¤„ç†å™¨
    console.log('ğŸš« å·²ç¦ç”¨æ‰€æœ‰åè®®æ³¨å†ŒåŠŸèƒ½');

    // ğŸš« ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„åè®®å¤„ç†é€»è¾‘
    // ä¸å†å¤„ç†ä»»ä½• open-url äº‹ä»¶ï¼ˆé™¤äº†ç”¨äºè°ƒè¯•çš„ç›‘å¬å™¨ï¼‰

    createWindow();
  })
  .catch((err) => console.error("åº”ç”¨å¯åŠ¨å¤±è´¥ï¼š", err));

app.on("window-all-closed", () => {
  // æ³¨é”€æ‰€æœ‰å…¨å±€å¿«æ·é”®
  globalShortcut.unregisterAll();
  console.log('âœ… å·²æ³¨é”€æ‰€æœ‰å…¨å±€å¿«æ·é”®');

  if (process.platform !== "darwin") app.quit();
});

app.on("activate", () => {
  if (BrowserWindow.getAllWindows().length === 0) createWindow();
});

ipcMain.handle("ping", async () => "pong from main process");

// æ¸…é™¤æŒ‡å®š webContents çš„ç¼“å­˜
ipcMain.handle("clear-cache", async (_evt, wcId: number) => {
  const wc = webContents.fromId(wcId);
  if (wc) await wc.session.clearCache();
  return true;
});

// åˆ é™¤æŒ‡å®špartitionçš„å­˜å‚¨æ–‡ä»¶å¤¹å’Œæ‰€æœ‰sessionæ•°æ®ï¼ˆåŒ…æ‹¬cookiesï¼‰
ipcMain.handle("delete-partition-storage", async (_evt, partitionName: string) => {
  return await deletePartitionStorageFolder(partitionName);
});

// åœ¨ä¸»è¿›ç¨‹ä¸­æ‰“å¼€æˆ–åˆ›å»º SQLite æ•°æ®åº“
async function getDb(customPath?: string): Promise<any> {
  let dbPath: string;

  if (customPath && customPath.trim() !== '') {
    // å¦‚æœæŒ‡å®šäº†éç©ºçš„è‡ªå®šä¹‰è·¯å¾„ï¼Œå¤„ç†ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
    if (path.isAbsolute(customPath)) {
      dbPath = customPath;
    } else {
      // ç›¸å¯¹è·¯å¾„å¤„ç†
      if (process.env.NODE_ENV === "development") {
        // å¼€å‘ç¯å¢ƒï¼šç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•
        dbPath = path.join(process.cwd(), customPath);
      } else {
        // ç”Ÿäº§ç¯å¢ƒï¼šç›¸å¯¹äºåº”ç”¨èµ„æºç›®å½•
        dbPath = path.join(process.resourcesPath, customPath);
      }
    }
  } else {
    // é»˜è®¤æ•°æ®åº“è·¯å¾„ï¼ˆç”¨æˆ·æ•°æ®ç›®å½•ï¼‰
    dbPath = path.join(app.getPath("userData"), "app.db");
  }

  console.log(`æ•°æ®åº“è·¯å¾„: ${dbPath}`);

  // ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
  const dbDir = path.dirname(dbPath);
  if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
  }

  return open({
    filename: dbPath,
    driver: sqlite3.Database,
  });
}

// å­˜å‚¨æ•°æ®åº“è¿æ¥
const dbConnections = new Map<string, any>();

// SQLite API å®ç°
// æ‰“å¼€æ•°æ®åº“è¿æ¥
ipcMain.handle("sqlite-open", async (_event, filePath: string) => {
  try {
    const db = await getDb(filePath);
    const connectionId = filePath;
    dbConnections.set(connectionId, db);
    return { success: true, connectionId };
  } catch (error) {
    console.error("Failed to open database:", error);
    return { success: false, error: (error as Error).message };
  }
});

// æ‰§è¡Œ SQL è¯­å¥
ipcMain.handle(
  "sqlite-run",
  async (_event, sql: string, params: any[] = []) => {
    try {
      const db = await getDb();
      const result = await db.run(sql, params || []);
      return { success: true, result };
    } catch (error) {
      console.error("Failed to run SQL:", error);
      return { success: false, error: (error as Error).message };
    }
  }
);

// æ‰§è¡Œ SQL æŸ¥è¯¢å¹¶è¿”å›æ‰€æœ‰ç»“æœ
ipcMain.handle(
  "sqlite-all",
  async (_event, sql: string, params: any[] = []) => {
    try {
      const db = await getDb();
      const rows = await db.all(sql, params || []);
      return { success: true, rows };
    } catch (error) {
      console.error("Failed to query SQL:", error);
      return { success: false, error: (error as Error).message };
    }
  }
);

// æ‰§è¡Œ SQL æŸ¥è¯¢å¹¶è¿”å›å•ä¸ªç»“æœ
ipcMain.handle(
  "sqlite-get",
  async (_event, sql: string, params: any[] = []) => {
    try {
      const db = await getDb();
      const row = await db.get(sql, params || []);
      return { success: true, row };
    } catch (error) {
      console.error("Failed to get SQL result:", error);
      return { success: false, error: (error as Error).message };
    }
  }
);

// RSA åŠ å¯†å¤„ç†å™¨
ipcMain.handle("encrypt-script", async (_event, text: string) => {
  try {
    const encrypted = encryptScript(text);
    return { success: true, encrypted };
  } catch (error) {
    console.error("åŠ å¯†å¤±è´¥:", error);
    return { success: false, error: (error as Error).message };
  }
});

// RSA è§£å¯†å¤„ç†å™¨
ipcMain.handle("decrypt-script", async (_event, encryptedText: string) => {
  try {
    const decrypted = decryptScript(encryptedText);
    return { success: true, decrypted };
  } catch (error) {
    console.error("è§£å¯†å¤±è´¥:", error);
    return { success: false, error: (error as Error).message };
  }
});

// å…³é—­åº”ç”¨ç¨‹åºå¤„ç†å™¨
ipcMain.handle("close-app", async () => {
  app.quit();
});
